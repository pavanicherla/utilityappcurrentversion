FROM pavanicherla/argocd:v2.7.2_v2 AS builder
#Dockerfile
RUN apt-get update -y && apt-get install -y \
        openssh-server \
        nginx \
        unzip \
        fcgiwrap \
        git-lfs \
        make \
        wget \
        gcc \
        zip
FROM alpine:3.18.4  

COPY --from=builder /usr/bin/openssh-server /usr/bin/openssh-server
COPY --from=builder /usr/bin/nginx /usr/bin/nginx
COPY --from=builder /usr/bin/unzip /usr/bin/unzip
COPY --from=builder /usr/bin/fcgiwrap /usr/bin/fcgiwrap
COPY --from=builder /usr/bin/git-lfs /usr/bin/git-lfs
COPY --from=builder /usr/bin/make /usr/bin/make
COPY --from=builder /usr/bin/wget /usr/bin/wget
COPY --from=builder /usr/bin/gcc /usr/bin/gcc
COPY --from=builder /usr/bin/zip /usr/bin/zip

ENV JQ_VERSION=1.6
ENV YQ_VERSION=v4.35.2
ENV AVP_VERSION=1.14.0

USER root

# System modules
RUN apt-get update -y && apt-get install -y \
        sudo \
        mysql-client \
        libcurl4 \
        curl \
        git \
        netcat \
        bind9 dnsutils \
        python3.11 \
        python3-pip \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*

# Python libraries
RUN pip install --upgrade pip && pip3 install --no-cache-dir \
        awscli==1.29.10

# Additional binaries
RUN curl -Lo /usr/local/bin/jq https://github.com/jqlang/jq/releases/download/jq-${JQ_VERSION}/jq-linux64 \
        && chmod +x /usr/local/bin/jq
RUN curl -Lo /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64 \
        && chmod +x /usr/local/bin/yq
RUN curl -Lo /usr/local/bin/argocd-vault-plugin https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v${AVP_VERSION}/argocd-vault-plugin_${AVP_VERSION}_linux_amd64 \
        && chmod +x /usr/local/bin/argocd-vault-plugin

# Create user
RUN ln -fs /usr/share/zoneinfo/Asia/Singapore /etc/localtime
RUN useradd -m -s /bin/bash -G sudo adak8s \
        && echo '' >> /etc/sudoers \
        && echo 'adak8s ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Change user
USER adak8s
WORKDIR /home/adak8s
